#!/usr/bin/env node
import{McpServer as G}from"@modelcontextprotocol/sdk/server/mcp.js";import{StdioServerTransport as A}from"@modelcontextprotocol/sdk/server/stdio.js";import{z as i}from"zod";import F from"fs";import q from"path";import{fileURLToPath as L}from"url";import{executeQuery as j,extractData as H,checkHealth as B}from"../datasources/grafana-client.js";import{buildAnalysisGuidance as b,generateDataOverview as z}from"../services/monitoring-analyzer.js";import{generateRequestId as $,storeRequestMetadata as D,storeResponseData as O,getResponseData as T,storeAnalysis as v,getAnalysis as M,listAllRequests as _,listRequestsBySession as U,getRequestStats as J,cleanupExpiredData as C}from"../services/data-store.js";import{createSession as Q,getSessionInfo as K,listSessions as W,deleteSession as V}from"../services/session-manager.js";import{loadConfig as X}from"../services/config-manager.js";const Y=L(import.meta.url),Z=q.dirname(Y),N=q.resolve(Z,"../../package.json"),ee=JSON.parse(F.readFileSync(N,"utf-8")),I={name:"grafana-mcp-analyzer",version:ee.version,description:`Grafana MCP\u5206\u6790\u5668 - \u76D1\u63A7\u6570\u636E\u67E5\u8BE2\u548C\u5206\u6790\u5DE5\u5177

\u{1F3AF} \u6838\u5FC3\u529F\u80FD\uFF1A\u9884\u5B9A\u4E49\u67E5\u8BE2\u3001\u6570\u636E\u5B58\u50A8\u3001AI\u5206\u6790\u6307\u5F15\u3001\u4F1A\u8BDD\u7BA1\u7406
\u{1F4CA} \u6570\u636E\u5904\u7406\uFF1A\u652F\u6301\u4EFB\u610F\u5927\u5C0F\u6570\u636E\uFF0C\u63D0\u4F9B\u5B8C\u6574\u6570\u636E\u5206\u6790 
\u{1F527} \u4F7F\u7528\u65B9\u5F0F\uFF1Alist_queries\u67E5\u770B\u53EF\u7528\u67E5\u8BE2\uFF0Canalyze_query\u8FDB\u884C\u5206\u6790`};let d={};function g(e,t=!1){return{content:[{type:"text",text:JSON.stringify(e,null,2)}],...t&&{isError:!0}}}function y(e){const t=e instanceof Error?e.message:e;return g({success:!1,error:t,timestamp:new Date().toISOString()},!0)}function E(e){const t=k();if(!t[e])throw new Error(`\u67E5\u8BE2\u914D\u7F6E\u4E0D\u5B58\u5728: ${e}`);return t[e]}function te(e,t){return e.type==="chunked"?e.resourceUris||[]:[e.resourceUri||`monitoring-data://${t}/data`]}async function P(e,t,r){await D(t,{timestamp:new Date().toISOString(),url:e.url,method:e.method||"POST",params:e.params,data:e.data,...r});const s=await x(e),n=await O(t,s),o=te(n,t);return{result:s,storageResult:n,resourceLinks:o}}async function x(e){const t=await j(e,d.baseUrl||"");if(!t.success)throw new Error(`\u67E5\u8BE2\u6267\u884C\u5931\u8D25: ${t.error}`);return H(t)}const m=new G(I);function k(){return d.queries||{}}function R(e){return async t=>{try{const r=t.href.split("/"),s=await e(r);return{contents:[{uri:t.href,text:typeof s=="string"?s:JSON.stringify(s,null,2),mimeType:"application/json"}]}}catch(r){return{contents:[{uri:t.href,text:`Error: ${r instanceof Error?r.message:String(r)}`,mimeType:"text/plain"}]}}}}m.resource("monitoring-data","monitoring-data://{requestId}/{dataType}",{title:"\u76D1\u63A7\u6570\u636E",description:"Grafana\u76D1\u63A7\u6570\u636E\u8D44\u6E90\u67E5\u770B\u5668"},R(async e=>{const t=e[2],r=e[3];return r==="analysis"?await M(t):r?.startsWith("chunk-")?await T(t,r):await T(t)})),m.resource("monitoring-data-index","monitoring-data-index://requests",{title:"\u6240\u6709\u8BF7\u6C42",description:"\u67E5\u770B\u6240\u6709\u53EF\u7528\u7684\u76D1\u63A7\u8BF7\u6C42"},R(async()=>await _())),m.resource("monitoring-data-index","monitoring-data-index://session/{sessionId}",{title:"\u4F1A\u8BDD\u8BF7\u6C42",description:"\u67E5\u770B\u6307\u5B9A\u4F1A\u8BDD\u4E2D\u7684\u6240\u6709\u8BF7\u6C42"},R(async e=>{const t=e.pop()||"";return await U(t)})),m.tool("check_health",{timeout:i.number().optional().describe("\u8D85\u65F6\u65F6\u95F4\uFF08\u6BEB\u79D2\uFF09"),expectedStatus:i.number().optional().describe("\u671F\u671B\u7684HTTP\u72B6\u6001\u7801")},async({timeout:e,expectedStatus:t})=>{try{let r={status:"healthy",timestamp:new Date().toISOString()};if(d.baseUrl&&d.healthCheck){const s=`${d.baseUrl}/${d.healthCheck.url}`;r=await B(s,{timeout:e,expectedStatus:t})}return g(r)}catch(r){return y(r)}}),m.tool("list_queries",{includeConfig:i.boolean().optional().describe("\u662F\u5426\u5305\u542B\u5B8C\u6574\u914D\u7F6E\u4FE1\u606F").default(!1)},async({includeConfig:e})=>{const t=d.queries?Object.keys(d.queries):[];return g({queries:t,count:t.length,...e&&{config:d.queries||{}}})}),m.tool("analyze_query",{queryName:i.string().describe("\u67E5\u8BE2\u540D\u79F0\uFF08\u4ECE\u914D\u7F6E\u6587\u4EF6\u83B7\u53D6\uFF09"),prompt:i.string().describe("\u5206\u6790\u9700\u6C42\u63CF\u8FF0"),sessionId:i.string().optional().describe("\u4F1A\u8BDDID\uFF08\u53EF\u9009\uFF09")},async({queryName:e,prompt:t,sessionId:r})=>{try{const s=E(e),n=$(),{result:o,storageResult:a,resourceLinks:c}=await P(s,n,{prompt:t,sessionId:r}),u=z(o),l=b(t,n,u,c,s);return await v(n,{prompt:t,timestamp:new Date().toISOString(),result:l,queryName:e,dataOverview:u,resourceLinks:c}),g({success:!0,requestId:n,queryName:e,dataSize:a.size,storageType:a.type,resourceLinks:c,analysisGuidance:l,message:`## \u67E5\u8BE2\u5206\u6790\u5B8C\u6210

**\u67E5\u8BE2:** ${e}
**\u8BF7\u6C42ID:** ${n}
**\u6570\u636E\u5927\u5C0F:** ${(a.size/1024).toFixed(2)} KB
**\u5B58\u50A8\u7C7B\u578B:** ${a.type}

${l}`})}catch(s){return y(s)}}),m.tool("query_data",{queryName:i.string().describe("\u67E5\u8BE2\u540D\u79F0\uFF08\u4ECE\u914D\u7F6E\u6587\u4EF6\u83B7\u53D6\uFF09"),description:i.string().optional().describe("\u67E5\u8BE2\u63CF\u8FF0"),sessionId:i.string().optional().describe("\u4F1A\u8BDDID\uFF08\u53EF\u9009\uFF09")},async({queryName:e,description:t,sessionId:r})=>{try{const s=E(e),n=$(),o=t||`\u67E5\u8BE2 ${e} \u6570\u636E`,{storageResult:a}=await P(s,n,{prompt:o,sessionId:r}),c=`## \u67E5\u8BE2\u5B8C\u6210

**\u67E5\u8BE2:** ${e}
**\u8BF7\u6C42ID:** ${n}
**\u6570\u636E\u5927\u5C0F:** ${(a.size/1024).toFixed(2)} KB
**\u5B58\u50A8\u7C7B\u578B:** ${a.type}
**\u65F6\u95F4\u6233:** ${new Date().toISOString()}

\u6570\u636E\u5DF2\u5B58\u50A8\uFF0C\u53EF\u7528\u4E8E\u540E\u7EED\u5206\u6790\u3002`;return g({requestId:n,queryName:e,dataSize:a.size,storageType:a.type,message:c,hasData:a.size>0})}catch(s){return y(s)}}),m.tool("aggregate_analyze",{queryNames:i.array(i.string()).describe("\u67E5\u8BE2\u540D\u79F0\u5217\u8868\uFF08\u4ECE\u914D\u7F6E\u6587\u4EF6\u83B7\u53D6\uFF09"),prompt:i.string().describe("\u805A\u5408\u5206\u6790\u9700\u6C42\u63CF\u8FF0"),sessionId:i.string().optional().describe("\u4F1A\u8BDDID\uFF08\u53EF\u9009\uFF09")},async({queryNames:e,prompt:t,sessionId:r})=>{try{const s=k(),n=[],o=[];let a=0;for(const p of e){if(!s[p])return y(`\u67E5\u8BE2\u914D\u7F6E\u4E0D\u5B58\u5728: ${p}`);const h=s[p],w=$();o.push(w),await D(w,{timestamp:new Date().toISOString(),url:h.url,method:h.method||"POST",params:h.params,data:h.data,prompt:`\u805A\u5408\u5206\u6790\u7684\u4E00\u90E8\u5206: ${p}`,sessionId:r});const S=await x(h),f=await O(w,S);a+=f.size,n.push({queryName:p,requestId:w,data:S,size:f.size,storageType:f.type,resourceUris:f.resourceUris,resourceUri:f.resourceUri})}const c={type:"aggregate-analysis",hasData:!0,status:"ok",timestamp:new Date().toISOString(),queryNames:e,totalSize:a,requestIds:o,stats:{queryCount:e.length,totalDataSize:a,averageDataSize:a/e.length}},u=n.flatMap(p=>p.storageType==="chunked"?p.resourceUris||[]:[p.resourceUri||`monitoring-data://${p.requestId}/data`]),l=b(`\u805A\u5408\u5206\u6790\u9700\u6C42: ${t}`,o[0],c,u,{systemPrompt:`\u60A8\u662F\u4E00\u4E2A\u4E13\u4E1A\u7684\u805A\u5408\u6570\u636E\u5206\u6790\u4E13\u5BB6\u3002\u8BF7\u5BF9\u591A\u4E2A\u67E5\u8BE2\u7684\u805A\u5408\u6570\u636E\u8FDB\u884C\u7EFC\u5408\u5206\u6790\uFF1A
1. \u8DE8\u67E5\u8BE2\u7684\u5173\u8054\u6027\u5206\u6790\u548C\u6574\u4F53\u8D8B\u52BF\u8BC6\u522B
2. \u591A\u7EF4\u5EA6\u6570\u636E\u5BF9\u6BD4\u548C\u5F02\u5E38\u6A21\u5F0F\u68C0\u6D4B
3. \u7CFB\u7EDF\u6027\u80FD\u74F6\u9888\u548C\u8D44\u6E90\u5229\u7528\u7387\u5206\u6790
4. \u4E1A\u52A1\u5F71\u54CD\u7684\u5168\u5C40\u8BC4\u4F30\u548C\u98CE\u9669\u9884\u8B66
5. \u7EFC\u5408\u4F18\u5316\u5EFA\u8BAE\u548C\u7CFB\u7EDF\u6539\u8FDB\u65B9\u6848

\u8BF7\u63D0\u4F9B\u5168\u9762\u7684\u805A\u5408\u5206\u6790\u62A5\u544A\uFF0C\u5305\u542B\u8DE8\u67E5\u8BE2\u7684\u5173\u8054\u5206\u6790\u548C\u6574\u4F53\u4F18\u5316\u5EFA\u8BAE\u3002`});return await v(o[0],{prompt:t,timestamp:new Date().toISOString(),result:l,type:"aggregate",queryNames:e,requestIds:o,dataOverview:c,resourceLinks:u}),g({success:!0,requestIds:o,queryNames:e,totalSize:a,resourceLinks:u,aggregateGuidance:l,message:`## \u805A\u5408\u5206\u6790\u5B8C\u6210

**\u67E5\u8BE2:** ${e.join(", ")}
**\u5206\u6790\u9700\u6C42:** ${t}
**\u6570\u636E\u603B\u5927\u5C0F:** ${(a/1024).toFixed(2)} KB
**\u8BF7\u6C42\u6570\u91CF:** ${o.length}

${l}`})}catch(s){return y(s)}}),m.tool("batch_analyze",{queryNames:i.array(i.string()).describe("\u67E5\u8BE2\u540D\u79F0\u5217\u8868\uFF08\u4ECE\u914D\u7F6E\u6587\u4EF6\u83B7\u53D6\uFF09"),prompt:i.string().describe("\u6279\u91CF\u5206\u6790\u9700\u6C42\u63CF\u8FF0"),sessionId:i.string().optional().describe("\u4F1A\u8BDDID\uFF08\u53EF\u9009\uFF09")},async({queryNames:e,prompt:t,sessionId:r})=>{try{const s=k(),n=[];for(const c of e){if(!s[c])return y(`\u67E5\u8BE2\u914D\u7F6E\u4E0D\u5B58\u5728: ${c}`);const u=s[c],l=$();await D(l,{timestamp:new Date().toISOString(),url:u.url,method:u.method||"POST",params:u.params,data:u.data,prompt:`\u6279\u91CF\u5206\u6790: ${c} - ${t}`,sessionId:r});const p=await x(u),h=await O(l,p),w=z(p),S=h.type==="chunked"?h.resourceUris||[]:[h.resourceUri||`monitoring-data://${l}/data`],f=b(`${t} - \u9488\u5BF9 ${c}`,l,w,S,u);await v(l,{prompt:`${t} - \u9488\u5BF9 ${c}`,timestamp:new Date().toISOString(),result:f,queryName:c,dataOverview:w,resourceLinks:S}),n.push({queryName:c,requestId:l,dataSize:h.size,storageType:h.type,analysisGuidance:f,resourceLinks:S})}const o=`## \u6279\u91CF\u5206\u6790\u5B8C\u6210

**\u67E5\u8BE2\u6570\u91CF:** ${e.length}
**\u5206\u6790\u9700\u6C42:** ${t}

`,a=n.map(c=>`### ${c.queryName}
**\u6570\u636E\u5927\u5C0F:** ${(c.dataSize/1024).toFixed(2)} KB
**\u5B58\u50A8\u7C7B\u578B:** ${c.storageType}
**\u5206\u6790\u6307\u5F15:**
${c.analysisGuidance}`).join(`

`);return g({success:!0,results:n,message:o+a})}catch(s){return y(s)}}),m.tool("manage_sessions",{action:i.enum(["list","create","get","delete"]).describe("\u64CD\u4F5C\u7C7B\u578B"),sessionId:i.string().optional().describe("\u4F1A\u8BDDID"),metadata:i.record(i.any()).optional().describe("\u4F1A\u8BDD\u5143\u6570\u636E")},async({action:e,sessionId:t,metadata:r})=>{try{switch(e){case"list":const s=await W();return g(s);case"create":const n=await Q(r||{});return g({success:!0,sessionId:n,message:"\u4F1A\u8BDD\u521B\u5EFA\u6210\u529F"});case"get":if(!t)return y("\u7F3A\u5C11\u4F1A\u8BDDID");const o=await K(t);return g(o);case"delete":if(!t)return y("\u7F3A\u5C11\u4F1A\u8BDDID");const a=await V(t);return g({success:a,message:a?"\u4F1A\u8BDD\u5220\u9664\u6210\u529F":"\u4F1A\u8BDD\u5220\u9664\u5931\u8D25"});default:return y("\u4E0D\u652F\u6301\u7684\u64CD\u4F5C")}}catch(s){return y(s)}}),m.tool("list_data",{sessionId:i.string().optional().describe("\u4F1A\u8BDDID\uFF0C\u4E0D\u63D0\u4F9B\u5219\u5217\u51FA\u6240\u6709\u6570\u636E"),limit:i.number().optional().default(10).describe("\u8FD4\u56DE\u6570\u91CF\u9650\u5236")},async({sessionId:e,limit:t})=>{try{let r;e?r=await U(e):r=await _();const s=r.slice(0,t),n=await Promise.all(s.map(async o=>{try{return await J(o.id)}catch{return{requestId:o.id,timestamp:o.timestamp,prompt:o.prompt,sessionId:o.sessionId,error:"Failed to get stats"}}}));return g({data:n,total:r.length,returned:s.length,sessionId:e||"all"})}catch(r){return y(r)}}),m.tool("server_status",{},async()=>g({server:I,config:{hasBaseUrl:!!d.baseUrl,hasHealthCheck:!!d.healthCheck,queryCount:Object.keys(d.queries||{}).length},timestamp:new Date().toISOString()}));async function re(){try{d=await X(process.env.CONFIG_PATH);const e=parseInt(process.env.DATA_EXPIRY_HOURS||"24",10);try{const r=await C(!1,e);r>0&&console.error(`\u{1F5D1}\uFE0F \u670D\u52A1\u542F\u52A8\u6E05\u7406\u5B8C\u6210\uFF0C\u5220\u9664\u4E86 ${r} \u4E2A\u8FC7\u671F\u8BF7\u6C42`)}catch(r){console.error("\u274C \u542F\u52A8\u65F6\u6570\u636E\u6E05\u7406\u5931\u8D25:",r)}setInterval(async()=>{try{const r=await C(!1,e);r>0&&console.error(`\u{1F5D1}\uFE0F \u5B9A\u65F6\u6E05\u7406\u5B8C\u6210\uFF0C\u5220\u9664\u4E86 ${r} \u4E2A\u8FC7\u671F\u8BF7\u6C42`)}catch(r){console.error("\u274C \u5B9A\u65F6\u6570\u636E\u6E05\u7406\u5931\u8D25:",r)}},60*60*1e3);const t=new A;await m.connect(t),console.error("\u2705 Grafana\u67E5\u8BE2\u5206\u6790MCP\u670D\u52A1\u5668\u5DF2\u542F\u52A8"),console.error(`\u{1F4CA} \u670D\u52A1\u5668\u4FE1\u606F: ${I.name} v${I.version}`),console.error(`\u{1F527} \u914D\u7F6E\u72B6\u6001: ${Object.keys(d.queries||{}).length} \u4E2A\u67E5\u8BE2`),console.error(`\u{1F5D1}\uFE0F \u6570\u636E\u6E05\u7406: ${e}\u5C0F\u65F6\u540E\u81EA\u52A8\u6E05\u7406\uFF0C\u6BCF\u5C0F\u65F6\u68C0\u67E5\u4E00\u6B21`)}catch(e){console.error("\u274C \u670D\u52A1\u5668\u542F\u52A8\u5931\u8D25:",e),process.exit(1)}}re().catch(e=>{console.error("\u274C \u672A\u5904\u7406\u7684\u9519\u8BEF:",e),process.exit(1)});
